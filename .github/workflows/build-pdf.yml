name: Build PDF

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'tex/**' ]
  pull_request:
    paths: [ 'tex/**' ]

jobs:
  latex:
    runs-on: ubuntu-latest
    permissions:
      contents: read        # needed by actions/checkout
      pull-requests: write  # you already wanted this

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install TinyTeX
        shell: bash
        run: |
          wget -qO- "https://yihui.org/tinytex/install-bin-unix.sh" | sh
          # Core engines/tools
          ~/bin/tlmgr install latexmk xetex
          # Packages used in your preamble
          ~/bin/tlmgr install \
            amsmath amsfonts amssymb mathtools \
            physics microtype enumitem siunitx booktabs tikz \
            hyperref cleveref placeins

      - name: Add TinyTeX to PATH
        run: echo "$HOME/bin" >> $GITHUB_PATH

      - name: Cache TinyTeX
        uses: actions/cache@v4
        with:
          path: ~/.TinyTeX
          key: tinytex-${{ hashFiles('tex/**/*.tex') }}

      - name: Compile main.tex
        working-directory: tex
        run: |
          latexmk -xelatex -interaction=nonstopmode -halt-on-error main.tex

      - name: Create smart filename
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            NAME="general-mechanics-PR${{ github.event.pull_request.number }}"
          else
            NAME="general-mechanics-$(date +%F)"
          fi
          cp tex/main.pdf "$NAME.pdf"
          echo "PDF=$NAME.pdf" >> $GITHUB_ENV

      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PDF }}
          path: ${{ env.PDF }}

      # Optional: commenting a base64-embedded PDF can exceed GitHub‚Äôs size limit.
      # Linking to the artifact is far more reliable.
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const name = process.env.PDF;
            const runId = process.env.GITHUB_RUN_ID;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner,
              repo,
              body: `üìÑ **general-mechanics PDF preview**\n\n` +
                    `The build artifact is attached to this workflow run.\n\n` +
                    `‚û°Ô∏è **Download**: look for **${name}** in the "Artifacts" section of the run.`
            });
