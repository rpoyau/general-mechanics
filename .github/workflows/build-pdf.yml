name: Build PDF

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'tex/**'
      # AF-Compliant Fix: Also trigger on changes to the workflow itself
      - '.github/workflows/build-pdf.yml'
  pull_request:
    paths:
      - 'tex/**'
      - '.github/workflows/build-pdf.yml'

jobs:
  latex:
    runs-on: ubuntu-latest
    permissions:
      contents: read      # needed by actions/checkout
      pull-requests: write # needed for PR comments

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 1. Restore TinyTeX Cache (must happen before install)
      - name: Restore TinyTeX Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: ~/.TinyTeX
          # AF-Compliant Fix: Invalidate the poisoned cache by bumping the version.
          # This forces the install step to run ONE time.
          key: ${{ runner.os }}-tinytex-v1.1
          restore-keys: |
            ${{ runner.os }}-tinytex-

      # 2. Conditional Install and Update (runs only if cache misses)
      - name: Install and Update TinyTeX (if cache miss)
        # Only run this step if the cache was not successfully restored
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          # Exit immediately if any command fails
          set -e

          echo "Cache miss. Installing TinyTeX and packages..."

          # Install TinyTeX base
          wget -qO- "https://yihui.org/tinytex/install-bin-unix.sh" | sh

          # Add the TinyTeX bin directory to the PATH for *this step*
          export PATH=$HOME/bin:$PATH

          # Update tlmgr and all packages to ensure freshness (optional, but robust)
          ~/bin/tlmgr update --self --all

          # Install packages one by one for superior error reporting.
          # NOTE: 'tikz' was replaced by 'pgf'. 'amssymb', 'amsthm', and 'bm' were removed.
          for pkg in latexmk xetex \
            geometry amsmath amsfonts mathtools \
            physics microtype enumitem siunitx booktabs pgf \
            hyperref cleveref placeins; do
            echo "Attempting to install: $pkg"
            # Use the conditional execution to explicitly report the failing package
            ~/bin/tlmgr install "$pkg" || { echo "ERROR: Failed to install LaTeX package '$pkg'. Please check spelling or availability."; exit 1; }
          done

      # 3. Add TinyTeX to PATH (The "Focusing Station" Fix)
      # This step is *unconditional* and runs *every time*,
      # ensuring the PATH is set correctly even on a cache hit.
      - name: Add TinyTeX to PATH
        run: echo "$HOME/bin" >> $GITHUB_PATH

      # 4. Compile (now using the cached or freshly installed environment)
      - name: Compile main.tex
        working-directory: tex
        run: |
          # AF-Compliant Fix: Explicitly set the PATH for *this step*
          # This is the "Focusing Station" that drains the CI PATH "swamp"
          export PATH="$HOME/bin:$PATH"
          latexmk -xelatex -interaction=nonstopmode -halt-on-error main.tex

      # 5. Create smart filename
      - name: Create smart filename
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            NAME="general-mechanics-PR${{ github.event.pull_request.number }}"
          else
            NAME="general-mechanics-$(date +%F)"
          fi
          # Note: The original path 'tex/main.pdf' is assumed to be correct
          cp tex/main.pdf "$NAME.pdf"
          echo "PDF=$NAME.pdf" >> $GITHUB_ENV

      # 6. Upload PDF
      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PDF }}
          path: ${{ env.PDF }}

      # 7. Comment on PR
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const name = process.env.PDF;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üìÑ **General Mechanics PDF preview**\n\n` +
                    `The build artifact is attached to this workflow run.\n\n` +
                    `‚û°Ô∏è **Download**: look for **${name}** in the "Artifacts" section of the run.`
            });